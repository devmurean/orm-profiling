#!/usr/bin/env php
<?php
$options = getopt('', [
    'concurrent:',
    'db:',
    'db_password:',
    'db_username:',
    'folder:',
    'group:',
    'help',
    'host:',
    'number:',
    'orm:',
    'memory_log',
    'xdebug',
]);
if (array_key_exists('help', $options) && $options['help'] === false) {
    echo 'php test [commands] ' . PHP_EOL .
    'Every command is mandatory ' .
    PHP_EOL . 'Commands:' . PHP_EOL .
    '    [--number int]             Number of request' . PHP_EOL .
    '    [--concurrent int]         Number of concurrent request' . PHP_EOL .
    '    [--orm doctrine|eloquent]  ORM selection, either Doctrine or Eloquent ' . PHP_EOL .
    '    [--db string]              Database name' . PHP_EOL .
    '    [--db_password string]     Database password' . PHP_EOL .
    '    [--db_username string]     Database username' . PHP_EOL .
    '    [--host string]            Test target, either IP address or domain name' . PHP_EOL .
    '    [--memory_log bool]        (Optional) Indicate that the memory logging is included in test' . PHP_EOL .
    '    [--xdebug bool]            (Optional) Indicate that the xdebug profiling is included in test' . PHP_EOL .
    '    [--group string]           Decide which test group to run. ' . PHP_EOL .
    '                               Groups: crud, st, tpc, tpcc, propagation, isolation'. PHP_EOL;
    return;
}
$endpoints = [
    // CRUD Group
    'crud' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/user'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/user'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/user/delete'
        ],
        [
            'method' => 'get',
            'name' => 'read',
            'value' => '/user'
        ],
        [
            'method' => 'get',
            'name' => 'lookup',
            'value' => '/user/lookup'
        ],
    ],

    // ST Group
    'st' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/st'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/st'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/st/delete'
        ],
        [
            'method' => 'get',
            'name' => 'read',
            'value' => '/st'
        ],
        [
            'method' => 'get',
            'name' => 'lookup',
            'value' => '/st/lookup'
        ],
    ],

    // TPC Group
    'tpc' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/tpc'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/tpc'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/tpc/delete'
        ],
        [
            'method' => 'get',
            'name' => 'read',
            'value' => '/tpc'
        ],
        [
            'method' => 'get',
            'name' => 'lookup',
            'value' => '/tpc/lookup'
        ],
    ],

    // TPCC Group
    'tpcc' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/tpcc'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/tpcc'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/tpcc/delete'
        ],
        [
            'method' => 'get',
            'name' => 'read',
            'value' => '/tpcc'
        ],
        [
            'method' => 'get',
            'name' => 'lookup',
            'value' => '/tpcc/lookup'
        ],
    ],

    // Propagation Group
    'propagation' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/propagation/add'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/propagation/update'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/propagation/delete'
        ],
    ],

    // Isolation Group
    'isolation' => [
        [
            'method' => 'post',
            'name' => 'create',
            'value' => '/isolation/add'
        ],
        [
            'method' => 'put',
            'name' => 'update',
            'value' => '/isolation/update'
        ],
        [
            'method' => 'post',
            'name' => 'delete',
            'value' => '/isolation/delete'
        ],
    ],

];

// Example command
// 'ab -k -n 100 -c 10 -p data.txt -T application/json localhost:8000/doctrine/user > profiling.txt'
function main(string $group, array $endpoints, array $options)
{
    echo 'Start profiling ' . $group . '...' . PHP_EOL;
    profile($group, $endpoints, $options);
    echo 'Done' . PHP_EOL;
    return;
}

function profile(string $group, array $endpoints, array $options, bool $isolation = false): void
{
    foreach ($endpoints[$group] as $e) {
        if ($isolation && $e['name'] === 'update') {
            $dbName = 'test_db_' . rand(10**4, 10**5-1);
            $command = 'mysql -u ' . $options['db_username'] . ' -p' . $options['db_password'] .
                ' -e "CREATE DATABASE ' . $dbName . ';"';
            exec($command);
            execAbCommand($group, $options, $e);
            $command = 'mysql -u ' . $options['db_username'] . ' -p' . $options['db_password'] .
                ' -e "DROP DATABASE ' . $dbName . ';"';
            exec($command);
        } else {
            execSeedingCommand($group, $options);
            execAbCommand($group, $options, $e);
        }
    }
}

/**
 * Reset related table content
 *
 * @param string $group
 * @param array $options
 * @return void
 */
function execSeedingCommand(string $group, array $options): void
{
    echo 'Prepare database table(s)...' . PHP_EOL;
     
    $command = 'mysql -u ' . $options['db_username']
        . ' --password=' . $options['db_password'] . ' '
        . $options['db'] . ' < ./mysql-dump/' . sqlDumpMapping($group);

    exec($command);
}

/**
 * Run ab command
 *
 * @param string $group
 * @param array $options
 * @param array $e Single item from $endpoints[$group]
 * @return void
 */
function execAbCommand(string $group, array $options, array $e): void
{
    $n = $options['number'];
    $c = $options['concurrent'];
    $orm = $options['orm'];
    $host = $options['host'];
    
    $endpoint = $host . '/' . $orm . $e['value'];
    $memory_log = $options['memory_log'] === false ? 'memory.' : '';
    $xdebug = $options['xdebug'] === false ? 'xdebug.' : '';
    // Command Builder
    echo 'Profiling ' . '['.$e['name'].'] ' . $endpoint . '...' . PHP_EOL;
    $command = 'ab -k -n ' . $n . ' -c ' . $c . ' ';
    $command .= $e['method'] === 'post' ? '-p data.txt -T application/json' : '';
    $command .= ' ' . $endpoint;
    $command .= ' > ' . getOutputFolder($options) .
         '/' . $group . '.ab.' . $memory_log . $xdebug . $e['name'] . '.' . time() . '.txt';

    // Command Execution
    exec($command);
    echo $endpoint . ' profiled...' . PHP_EOL . PHP_EOL;
}

function getOutputFolder(array $options)
{
    if (array_key_exists('memory_log', $options)) {
        return 'memory-profiling-result';
    } elseif (array_key_exists('xdebug', $options)) {
        return 'xdebug-profiling-result';
    } else {
        return 'load-profiling-result';
    }
}

function sqlDumpMapping(string $group): string
{
    $list = [
        'crud' => 'orm_profiling_crud.sql',
        'st' => 'orm_profiling_st.sql',
        'tpc' => 'orm_profiling_tpc.sql',
        'tpcc' => 'orm_profiling_tpcc.sql',
        'propagation' => 'orm_profiling_isolation_propagation',
    ];

    return $list[$group];
}

main(group: $options['group'], endpoints: $endpoints, options: $options);
