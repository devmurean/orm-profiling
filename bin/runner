#!/usr/bin/env php
<?php
$options = getopt('', [
    'memory_log',
    'xdebug',
    'db:',
    'db_password:',
    'db_username:',
]);
$isXdebugActive = array_key_exists('xdebug', $options);
$isMemoryLogActive = array_key_exists('memory_log', $options);

$orms = ['doctrine','eloquent'];
$groups = ['crud', 'st', 'tpc', 'tpcc', 'propagation', 'isolation'];
$records = (!$isXdebugActive && !$isMemoryLogActive) ? [100, 1000, 10000, 100000] : [100];

$commands = [];
foreach ($orms as $orm) {
    foreach ($groups as $group) {
        foreach ($records as $record) {
            $xdebug = $isXdebugActive ? '--xdebug' : '';
            $memory = $isMemoryLogActive ? '--memory_log' : '';
            $commands[] = 'php test --record '.$record.' --db "'.$options['db'].'" '
            . '--db_password "'.$options['db_password'].'" --db_username "'.$options['db_username'].'" '
            . '--host "localhost:8000" '
            . '--orm '.$orm.' --group "'.$group.'" ' . $xdebug . ' ' . $memory;
        }
    }
}

foreach ($commands as $command) {
    $n = (!$isXdebugActive && !$isMemoryLogActive) ? 10 : 1;
    for ($i=0; $i < $n;$i++) {
        exec($command);
    }
    echo 'rest before next command for a second...' . PHP_EOL;
    sleep(1);
}
